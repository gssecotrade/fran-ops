name: Fran Ops — Scheduler

on:
  schedule:
    - cron: "0 8 * * *"   # 08:00 UTC diario
  workflow_dispatch: {}

jobs:
  run_ops:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (ligero)
        run: |
          python -m pip install --upgrade pip
          if [ -f ops/scripts/requirements.txt ]; then
            pip install -r ops/scripts/requirements.txt
          else
            pip install pandas google-api-python-client google-auth google-auth-httplib2 \
                       google-auth-oauthlib yagmail
          fi

      # ---------------- EXTRACCIÓN ----------------
      - name: Sheets -> CSV
        env:
          GOOGLE_SA_JSON: ${{ secrets.GOOGLE_SA_JSON || vars.GOOGLE_SA_JSON }}
        run: |
          python ops/scripts/sheets_to_csv.py || true

      # ---------------- NORMALIZACIÓN ----------------
      - name: Normalize Loterías
        run: |
          python ops/scripts/normalize_loterias.py

      # ---------------- DATA QUALITY ----------------
      - name: Data Quality
        continue-on-error: true
        run: |
          python ops/scripts/dq_loterias.py

      # ---------------- ZIP ----------------
      - name: ZIP artefacts
        run: |
          bash ops/scripts/zip_all.sh

      # ---------------- DRIVE (subida + autolimpieza) ----------------
      - name: Upload to Google Drive (with cleanup)
        env:
          GOOGLE_SA_JSON:   ${{ secrets.GOOGLE_SA_JSON   || vars.GOOGLE_SA_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID || vars.GDRIVE_FOLDER_ID }}
          GDRIVE_CLEANUP_DAYS: ${{ vars.GDRIVE_CLEANUP_DAYS }}
        run: |
          python ops/scripts/upload_to_gdrive.py

      # ---------------- EMAIL ----------------
      - name: Send summary email
        if: ${{ always() }}
        continue-on-error: true
        env:
          SMTP_USER: ${{ secrets.SMTP_USER || vars.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS || vars.SMTP_PASS }}
          SMTP_TO:   ${{ secrets.SMTP_TO   || vars.SMTP_TO   }}
        run: |
          python ops/scripts/send_summary_email.py

      # ---------------- PÁGINA DQ (JSON + HTML) ----------------
      - name: Build report.json + docs/index.html
        run: |
          python ops/scripts/make_report.py
          if [ ! -f dist/report.json ]; then
            echo '{
              "ts_utc":"'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'",
              "status":{"OK":0,"WARN":0,"FAIL":1,"WARN_LIST":[]},
              "manifest":"—","master_csv":false,"zips":[],"drive_links":[]
            }' > dist/report.json
          fi
          test -f docs/index.html

      # ---------------- HOJA DE CONTROL ----------------
  update-control-sheet:
    name: Update control sheet
    runs-on: ubuntu-latest
    needs: build          # si tu build genera dist/report.json
    if: ${{ !cancelled() }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps (gspread)
        run: |
          python -m pip install --upgrade pip
          pip install gspread google-auth

      - name: Run updater
        env:
          CONTROL_SHEET_ID: ${{ secrets.CONTROL_SHEET_ID }}
          # Tu repo tiene este secreto:
          GOOGLE_SA_JSON_BASE64: ${{ secrets.GOOGLE_SA_JSON_BASE64 }}
          # (opcional) por si quieres forzar nombre de pestaña:
          CONTROL_SHEET_TAB: Control_Pipeline
          # (opcional) URL pública del panel, si quieres que quede guardada:
          PANEL_URL: https://gssecotrade.github.io/fran-ops/
          # Para meter el run id en la fila:
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          python ops/scripts/update_control_sheet.py
