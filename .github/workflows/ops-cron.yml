name: Build & publish LAE JSONs

on:
  workflow_dispatch:
  schedule:
    # cada hora a :07 por si hay nuevos sorteos
    - cron: "7 * * * *"

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      - name: Make output dir
        run: mkdir -p docs/api

      # ====== Latest (1–3 últimos sorteos por juego) ======
      - name: Build docs/api/lae_latest.json
        run: |
          python OPS/scripts/fetch_lae_latest.py docs/api/lae_latest.json
          python - << 'PY'
          import json,sys
          p='docs/api/lae_latest.json'
          j=json.load(open(p,encoding='utf-8'))
          if not isinstance(j,dict) or 'results' not in j:
              raise SystemExit("latest.json inválido (sin 'results')")
          print(f"[check] latest OK: {len(j['results'])} draws")
          PY

      # ====== Histórico (paginas parseadas; ver flags en el script) ======
      - name: Build docs/api/lae_historico.json
        run: |
          # Por defecto, recorre varias páginas por juego (ver flags en el script)
          python OPS/scripts/fetch_lae_historic.py --pages 12 docs/api/lae_historico.json
          python - << 'PY'
          import json,sys
          p='docs/api/lae_historico.json'
          j=json.load(open(p,encoding='utf-8'))
          if not isinstance(j,dict) or 'results' not in j:
              raise SystemExit("historico.json inválido (sin 'results')")
          print(f"[check] historic OK: {len(j['results'])} draws")
          PY

      - name: Commit & push (rebase safe)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase
          git add docs/api/lae_latest.json docs/api/lae_historico.json
          git commit -m "ops: update LAE JSONs (latest & historic)" || echo "No changes"
          git push
