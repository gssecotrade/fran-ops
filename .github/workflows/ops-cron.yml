name: ops-cron

on:
  schedule:
    # cada hora (ajusta a tu gusto)
    - cron: "0 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build lae_latest.json
        run: |
          mkdir -p docs/api
          python ops/scripts/fetch_lae_latest.py
          echo "---- head ----"
          head -n 60 docs/api/lae_latest.json || true
          echo "---- size ----"
          wc -c docs/api/lae_latest.json || true

      # Guard-rail: NO se permite publicar sorteos con date vacío
      # Permitimos results == [] (mejor publicar vacío que basura)
      - name: Guard-rail: fail if any result has empty date
        run: |
          sudo apt-get update >/dev/null 2>&1
          sudo apt-get install -y jq >/dev/null 2>&1
          set -e
          jq -e '
            (.results | type == "array") and
            (
              (.results | length) == 0
              or
              (all(.results[]?; (.date != null) and (.date|tostring|length > 0)))
            )
          ' docs/api/lae_latest.json >/dev/null \
          || (echo "ERROR: results contiene items con \"date\" vacío o nulo"; exit 1)

      - name: Auto-commit lae_latest.json (pages)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: docs/api/lae_latest.json
          branch: main
          commit_message: "chore: update docs/api/lae_latest.json"
          commit_author: "gssecotrade <199840932+gssecotrade@users.noreply.github.com>"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
